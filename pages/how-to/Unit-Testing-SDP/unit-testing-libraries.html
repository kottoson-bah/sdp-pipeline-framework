

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Unit Testing a Library &mdash; Solutions Delivery Platform  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/style.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/banner.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Unit Testing a Pipeline Template" href="unit-testing-pipeline-templates.html" />
    <link rel="prev" title="How To Unit Test SDP" href="index.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Solutions Delivery Platform
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../libraries/index.html">Pipeline Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../for-framework-devs/index.html">For Framework Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../for-library-devs/index.html">For Library Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../for-sdp-users/index.html">For SDP Users</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">How-To’s</a><ul class="current">
<li class="toctree-l2"><a class="reference external" href="https://help.github.com/articles/creating-a-new-organization-from-scratch/">Create a GitHub Organization</a></li>
<li class="toctree-l2"><a class="reference external" href="https://www.twistlock.com/2018/05/08/securing-containers-red-hat-openshift-twistlock-deployment-script/">Deploy Twistlock to OpenShift</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">How To Unit Test SDP</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Unit Testing a Library</a></li>
<li class="toctree-l3"><a class="reference internal" href="unit-testing-pipeline-templates.html">Unit Testing a Pipeline Template</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../add_jenkins_credentials.html">Add Credentials to Jenkins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deploy-openshift-on-aws-csn.html">Deploy OpenShift on AWS CSN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deploy_sdp.html">Deploy SDP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../github_repository_configuration_best_practices.html">Configure A GitHub Repository With Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helm-multitenancy.html">Helm Multitenancy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../selenium_grid_configurations.html">How To Configure Selenium Grid</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute-to-docs.html">Contribute to the Docs</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Solutions Delivery Platform</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">How-To’s</a> &raquo;</li>
        
          <li><a href="index.html">How To Unit Test SDP</a> &raquo;</li>
        
      <li>Unit Testing a Library</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/pages/how-to/Unit-Testing-SDP/unit-testing-libraries.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  





<div class="section" id="unit-testing-a-library">
<h1>Unit Testing a Library<a class="headerlink" href="#unit-testing-a-library" title="Permalink to this headline">¶</a></h1>
<div class="section" id="the-purpose-of-unit-tests">
<h2>The Purpose of Unit Tests<a class="headerlink" href="#the-purpose-of-unit-tests" title="Permalink to this headline">¶</a></h2>
<p>The purpose of writing unit tests for pipeline libraries is to confirm that
they function the way we expect. It also gives us a way to confirm that any
features that were added to a library didn’t inadvertently break other features.</p>
</div>
<div class="section" id="where-are-the-tests">
<h2>Where Are The Tests?<a class="headerlink" href="#where-are-the-tests" title="Permalink to this headline">¶</a></h2>
<p>Unit tests are in the <code class="docutils literal"><span class="pre">/unit-test</span></code> directory of each pipeline library repo. Each
pipeline step (e.g. “build”, “penetration_test”) has a groovy file containing
its test specification. Each Spec file contains one or more unit tests designed
to verify the step functions as intended.</p>
</div>
<div class="section" id="how-are-the-tests-written">
<h2>How Are the Tests Written?<a class="headerlink" href="#how-are-the-tests-written" title="Permalink to this headline">¶</a></h2>
<div class="section" id="the-testing-framework">
<h3>The Testing Framework<a class="headerlink" href="#the-testing-framework" title="Permalink to this headline">¶</a></h3>
<p>We test pipeline libraries using Jenkins-Spock, a variation of the Spock testing
framework that has been designed around testing Jenkins pipelines. You can view
the documentation for Jenkins-Spock on its <a href="https://github.com/homeaway/jenkins-spock" target="_blank">GitHub Repository</a>, while more
general Spock documentation is available at <a href="http://spockframework.org/spock/docs" target="_blank">this link</a>.</p>
</div>
<div class="section" id="writing-a-specification-file">
<h3>Writing a Specification File<a class="headerlink" href="#writing-a-specification-file" title="Permalink to this headline">¶</a></h3>
<p>A “specification” is a list of features derived from business requirements. A
specification file contains that list of features as unit tests, and those
tests validate that the features work as expected. There should be a separate
file for each pipeline step in your library.</p>
<p>Below is an outline of a specification file. It shows what you need to include
in order to run tests, as well as some conventions for what to name methods and
variables. Create a groovy file with the same name as the class (such as
MyPipelineStepSpec.groovy) and use this outline to get you started, making sure
to swap names with ones for your library.</p>
<div class="highlight-groovy"><div class="highlight"><pre><span></span><span class="c1">// Start by importing the Jenkins-Spock framework Code</span>
<span class="kn">import</span> <span class="nn">com.homeaway.devtools.jenkins.testing.JenkinsPipelineSpecification</span>

<span class="c1">// Create a new class for the Spec</span>
<span class="c1">// The naming convention is the pipeline step&#39;s name, followed by Spec,</span>
<span class="c1">// all camel-cased starting w/ a capital.</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyPipelineStepSpec</span> <span class="kd">extends</span> <span class="n">JenkinsPipelineSpecification</span> <span class="o">{</span>

  <span class="c1">// Define the variable that will store the step&#39;s groovy code. This variable</span>
  <span class="c1">// follows the same naming variable as the class name, with Spec omitted.</span>
  <span class="kt">def</span> <span class="n">MyPipelineStep</span> <span class="o">=</span> <span class="kc">null</span>

  <span class="c1">// setup() is a fixture method that gets run before every test.</span>
  <span class="c1">// http://spockframework.org/spock/docs/1.2/spock_primer.html#_fixture_methods</span>
  <span class="kt">def</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// It&#39;s required to load the pipeline script as part of setup()</span>
    <span class="c1">// With the library monorepo, pipeline step groovy files can be found in &quot;sdp/libraries&quot;</span>
    <span class="n">MyPipelineStep</span> <span class="o">=</span> <span class="n">loadPipelineScriptForTest</span><span class="o">(</span><span class="s2">&quot;sdp/libraries/my_library/my_pipeline_step.groovy&quot;</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="c1">// Write a test (i.e. Feature Method) for each feature you wish to validate</span>
  <span class="c1">// http://spockframework.org/spock/docs/1.2/spock_primer.html#_feature_methods</span>
  <span class="kt">def</span> <span class="s2">&quot;Successful Build Sends Success Result&quot;</span> <span class="o">()</span> <span class="o">{</span>
    <span class="nl">setup:</span>
      <span class="c1">// unlike in the pipeline, the config object is not loaded during</span>
      <span class="c1">// unit tests. Use this to set it manually</span>
      <span class="n">MyPipelineStep</span><span class="o">.</span><span class="na">getBinding</span><span class="o">().</span><span class="na">setVariable</span><span class="o">(</span><span class="s2">&quot;config&quot;</span><span class="o">,</span> <span class="o">[</span> <span class="nl">field:</span> <span class="s2">&quot;String&quot;</span> <span class="o">])</span>
    <span class="nl">when:</span>
      <span class="c1">// This is the &quot;stimulus&quot;. It does things so we can test what happens</span>
      <span class="c1">// Typically, you execute the step&#39;s groovy code like this</span>
      <span class="n">MyPipelineStep</span><span class="o">()</span>
    <span class="nl">then:</span>
      <span class="c1">// Here&#39;s where you describe the expected response</span>
      <span class="c1">// If everything in here is valid, the test passes</span>
      <span class="mi">1</span> <span class="o">*</span> <span class="n">getPipelineMock</span><span class="o">(</span><span class="s2">&quot;sh&quot;</span><span class="o">)(</span><span class="s2">&quot;echo \&quot;field = String\&quot;&quot;</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="running-tests">
<h3>Running Tests<a class="headerlink" href="#running-tests" title="Permalink to this headline">¶</a></h3>
<p>It’s assumed these spec files are in the “test” directory of the pipeline-framework
repository. This repo has been set up to run Jenkins-Spock tests using <a class="reference external" href="http://maven.apache.org/">Maven</a>.
from the root of the pipeline-framework repo, run <code class="docutils literal"><span class="pre">mvn</span> <span class="pre">clean</span> <span class="pre">verify</span></code></p>
</div>
<div class="section" id="writing-tests">
<h3>Writing Tests<a class="headerlink" href="#writing-tests" title="Permalink to this headline">¶</a></h3>
<p>Now that you’ve laid the groundwork for your tests, it’s time to write them. These
are the “Feature Methods” because there should be one for each feature. Some of
the things to write tests for are:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Things are built correctly (objects, string variables, maps, etc.)</li>
<li>Conditional Hierarchies function as expected</li>
<li>Variables get passed correctly</li>
<li>Things fail when they’re supposed to</li>
</ol>
</div></blockquote>
<p>Once you know the feature you’re testing, like “Pipeline Fails When Config Is
Undefined”, write a feature method for it</p>
<div class="highlight-groovy"><div class="highlight"><pre><span></span><span class="kt">def</span> <span class="s2">&quot;Pipeline Fails When Config Is Undefined&quot;</span> <span class="o">()</span> <span class="o">{</span>

<span class="o">}</span>
</pre></div>
</div>
<p>Now create a setup “block” to define some do some pre-test preparation not
covered by the <code class="docutils literal"><span class="pre">setup()</span></code> fixture method. In this example, the binding
variable “config” is set to null, and a mock for the <code class="docutils literal"><span class="pre">error</span></code> pipeline step
is created.</p>
<div class="highlight-groovy"><div class="highlight"><pre><span></span><span class="kt">def</span> <span class="s2">&quot;Pipeline Fails When Config Is Undefined&quot;</span> <span class="o">()</span> <span class="o">{</span>
  <span class="nl">setup:</span>
    <span class="n">explicitlyMockPipelineStep</span><span class="o">(</span><span class="s2">&quot;error&quot;</span><span class="o">)</span>
    <span class="n">MyPipelineStep</span><span class="o">.</span><span class="na">getBinding</span><span class="o">.</span><span class="na">setVariable</span><span class="o">(</span><span class="s2">&quot;config&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Now to execute the pipeline step and test the response. This happens in
the “when” and “then” blocks, respectively. In this example, the pipeline step
is called (with no parameters), and I state that I expect the <code class="docutils literal"><span class="pre">error</span></code> step to
be called exactly once with the message <code class="docutils literal"><span class="pre">&quot;ERROR:</span> <span class="pre">config</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">defined&quot;</span></code></p>
<div class="highlight-groovy"><div class="highlight"><pre><span></span><span class="kt">def</span> <span class="s2">&quot;Pipeline Fails When Config Is Undefined&quot;</span> <span class="o">()</span> <span class="o">{</span>
  <span class="nl">setup:</span>
    <span class="n">explicitlyMockPipelineStep</span><span class="o">(</span><span class="s2">&quot;error&quot;</span><span class="o">)</span>
    <span class="n">MyPipelineStep</span><span class="o">.</span><span class="na">getBinding</span><span class="o">.</span><span class="na">setVariable</span><span class="o">(</span><span class="s2">&quot;config&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">)</span>
  <span class="nl">when:</span>
    <span class="n">MyPipelineStep</span><span class="o">()</span> <span class="c1">// Run the pipeline step we loaded, with no parameters</span>
  <span class="nl">then:</span>
    <span class="mi">1</span> <span class="o">*</span> <span class="n">getPipelineMock</span><span class="o">(</span><span class="s2">&quot;error&quot;</span><span class="o">)(</span><span class="s2">&quot;ERROR: config is not defined&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
<p>And that’s the jist of it. You can add as many feature methods as necessary
in the spec file, testing a variety of things. Be sure to check out the Spock
Documentation, Jenkins-Spock Documentation, and already-created spec files in
this repository for examples.</p>
</div>
</div>
<div class="section" id="faq">
<h2>FAQ<a class="headerlink" href="#faq" title="Permalink to this headline">¶</a></h2>
<p>This section covers some of the questions not easily answered in the Spock or
Jenkins-Spock documentation.</p>
<p><strong>Q: What’s the difference between explicitlyMockPipelineStep and explicitlyMockPipelineVariable?</strong></p>
<p><strong>A: Practically speaking, the difference is you can omit “.call” for explicitlyMockPipelineStep() when you use getPipelineMock()</strong></p>
<p>In the example above, I used <code class="docutils literal"><span class="pre">explicitlyMockPipelineStep()</span></code> to mock <code class="docutils literal"><span class="pre">error</span></code>.
Because of that, if I want to see if the <code class="docutils literal"><span class="pre">error</span></code> pipeline step is run, I use
<code class="docutils literal"><span class="pre">1</span> <span class="pre">*</span> <span class="pre">getPipelineMock(&quot;error&quot;)</span></code>. If I were to create the mock using
<code class="docutils literal"><span class="pre">explicitlyMockPipelineVariable()</span></code> I would instead use <code class="docutils literal"><span class="pre">1</span> <span class="pre">*</span> <span class="pre">getPipelineMock(&quot;error.call&quot;)</span></code></p>
<p>There may be some additional differences as well, so try to use what makes the most sense</p>
<p>—</p>
<p><strong>Q: What if I don’t know exactly what the parameters are going to be?</strong></p>
<p><strong>A: There are ways to match parameters to regex expressions, as well as test
parameters individually</strong></p>
<p>The standard format for interaction-based tests are</p>
<div class="highlight-groovy"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">count</span><span class="o">&gt;</span> <span class="o">*</span> <span class="n">getPipelineMock</span><span class="o">(&lt;</span><span class="n">method</span><span class="o">&gt;)(&lt;</span><span class="n">parameter</span><span class="o">(</span><span class="n">s</span><span class="o">)&gt;)</span>
</pre></div>
</div>
<p>While you can put the exact parameter value in the second parentheses, you can
also run arbitrary groovy code inside curly brackets. Whether or not it’s a “match”
depends on if that code returns <code class="docutils literal"><span class="pre">true</span></code> or <code class="docutils literal"><span class="pre">false</span></code>. A good example is in
PenetrationTestSpec.groovy. Use <code class="docutils literal"><span class="pre">it</span></code> to get the value of the parameter.
<code class="docutils literal"><span class="pre">`1</span> <span class="pre">*</span> <span class="pre">getPipelineMock(&quot;sh&quot;)({it</span> <span class="pre">=~</span> <span class="pre">/</span> <span class="pre">(zap-cli</span> <span class="pre">open-url)</span> <span class="pre">Kirk</span> <span class="pre">(.+)/})`</span></code></p>
<p>—</p>
<p><strong>Q: Do I have to do interaction-based testing?</strong></p>
<p><strong>A: No, but you can’t get variables the same way as traditional Spock tests</strong></p>
<p>This is because the script gets run in that <code class="docutils literal"><span class="pre">loadPipelineScriptForTest</span></code> object.
You can only access variables stored in the binding, which are few. It makes more
sense to see how variables are being used in pipeline steps, and make sure those
pipeline steps use the correct value for those variables.</p>
<p>Similarly, if you need to control how a variable is set, you need to stub whatever
method or pipeline step that sets the initial value for that variable</p>
<p>As an example, in PenetrationTestSpec.groovy, the <code class="docutils literal"><span class="pre">target</span></code> variable in
penetration_test.groovy is tested by checking the parameters to an <code class="docutils literal"><span class="pre">sh</span></code> step.</p>
<p>—</p>
<p><strong>Q: I keep getting “can’t run method foo() on null; what do I do?”</strong>
<strong>A: You need to find a way to stub the method that sets the value for the object that calls foo()</strong></p>
<p>There should be an example in GetImagesToBuildSpec.groovy</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="unit-testing-pipeline-templates.html" class="btn btn-neutral float-right" title="Unit Testing a Pipeline Template" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="How To Unit Test SDP" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Booz Allen Hamilton. All Rights Reserved. 
  This software package is licensed under the Booz Allen Public License. The license can be found in the License file or at http://boozallen.github.io/licenses/bapl.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: master
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../master/pages/how-to/Unit-Testing-SDP/unit-testing-libraries.html">master</a></dd>
            <dd><a href="../../../owasp-dep-check-lib/index.html">owasp-dep-check-lib</a></dd>
            <dd><a href="../../../steven-terrana-patch-1/index.html">steven-terrana-patch-1</a></dd>
        </dl>
    </div>
</div>


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>